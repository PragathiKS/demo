pipeline {
    agent {
        node {
        label 'cfe-deploy'
        }
    }

parameters {
    string(name: 'ZAPURL', defaultValue: 'https://tetrapak-dev64a.adobecqms.net/', description: 'Enter URL for testing')
}

    stages {
        stage('ZAP Test') {
            steps {
                script {
                    zaptest()        
                }
            }
        }
    }
}

def zaptest() {
            echo "Starting zap test"
            reportname = "Adhoc_ZAP_Report"
            sh 'docker stop zap'
            sh 'docker rm zap'
            sh 'docker run --add-host tetrapak-dev64a.dev.adobecqms.net:104.46.45.30 -e LANG=C.UTF-8 --detach --name zap -u zap -v "$(pwd)/reports":/zap/reports/:rw owasp/zap2docker-stable zap.sh -daemon -host 0.0.0.0  -config api.addrs.addr.name=.* -config api.addrs.addr.regex=true -config api.disablekey=true'
            sh 'sleep 90'
            sh "docker exec  zap zap-cli spider '${ZAPURL}'"
            sh "sleep 60"
            sh 'docker exec  zap zap-cli report -f html -o zap.html'
            sh 'mkdir -p zap-Adhoc'
            sh 'docker cp zap:zap/zap.html ZAPReportAdhoc.html'
            sh 'mv ZAPReportAdhoc.html zap-Adhoc/ZAPReportAdhoc.html'
            sh 'docker stop zap'
            sh 'docker rm zap'
            publishHTML([allowMissing: false, alwaysLinkToLastBuild: false, keepAll: true, reportDir: 'zap-Adhoc', reportFiles: 'ZAPReportAdhoc.html', reportName: 'Adhoc_ZAP_Report', reportTitles: ''])
}
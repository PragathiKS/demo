pipeline{
agent {
                node {
                label 'cfe-deploy'
        }
}
parameters {
        choice('Environment', ['STAGE', 'QA'], 'Select environment')
        booleanParam defaultValue: false, description: 'Please check in case you want to deploy Commons Module', name: 'Deploy_Commons'
        string(name: 'Snapshot Commons', defaultValue: 'SnapshotVersion', description: '')
        booleanParam defaultValue: false, description: 'Please check in case you want to deploy Customer hub Module', name: 'Deploy_customerHub'
        string(name: 'Snapshot CustomerHub', defaultValue: 'SnapshotVersion', description: '')
        booleanParam defaultValue: false, description: 'Please check in case you want to deploy Public Web Module', name: 'Deploy_PublicWeb'
        string(name: 'Snapshot PublicWeb', defaultValue: 'SnapshotVersion', description: '')
    }
options {
        buildDiscarder(logRotator(numToKeepStr: '30'))
        disableConcurrentBuilds()
    }
    environment {
        sonar_url = "https://sonarcloud.io"
        login_token = "2354fbb990d5494aad3c578f2c9dd65147d01e02"
        author_url = "https://author-tetrapak-dev64a.adobecqms.net"
        publish_url = "http://13.69.73.197:4503"
        package_name = "tetrapak-complete-package"
        test_url_cuhu = "https://tetrapak-dev64a.adobecqms.net/content/tetrapak/customerhubtools/global/en/dashboard.html https://tetrapak-dev64a.adobecqms.net/content/tetrapak/customerhubtools/global/en/financials.html"
        test_url_pw = "http://tetrapak-dev64a.adobecqms.net/content/tetrapak/public-web/global/en/innovations.html http://tetrapak-dev64a.adobecqms.net/content/tetrapak/public-web/global/en.html http://tetrapak-dev64a.adobecqms.net/content/tetrapak/public-web/global/en/solutions.html"
        test_url_pally_zap_cuhu = "https://tetrapak-dev64a.adobecqms.net/content/tetrapak/customerhubtools/global/en/dashboard.html"
        test_url_pally_zap_pw = "https://tetrapak-dev64a.adobecqms.net/content/tetrapak/public-web/global/en.html"
        karmapath_cuhu = "${env.WORKSPACE}/tetrapak-customerhub/ui.dev/src/coverage"
        karmapath_pw = "${env.WORKSPACE}/tetrapak-publicweb/ui.dev/src/coverage"
        deploy_id_number = ""
    }


stages{

stage('Author Deployment and Replication to Publish')
         
                       {
                        steps {
                                                                        script {
                                                                                        if (params.Deploy_Commons)
                                                                                                {
                                                echo "Uninstalling Old Commons Package on author for Commons"
                                                sh "curl -u admin:Oa=]2Z7u#w@Mkojms*V=mj\\>a -F force=true '${author_url}/crx/packmgr/service.jsp?cmd=uninst&name=tetrapak-commons.complete'"
                                                sleep 20
                                                echo "Deleting Old Commons Package on author"
                                                sh "curl -u admin:Oa=]2Z7u#w@Mkojms*V=mj\\>a -F force=true '${author_url}/crx/packmgr/service.jsp?cmd=rm&name=tetrapak-commons.complete'"
                                                sleep 10
                                                echo "Uploading New Commons Package on author"
                                                sh "curl -u admin:Oa=]2Z7u#w@Mkojms*V=mj\\>a -F name=tetrapak-customerhub.complete -F file=@$workspace@2/tetrapak-commons/complete/target/tetrapak-commons.complete-1.0.0-DEV${deploy_id_number}-SNAPSHOT.zip -F force=true '${author_url}/crx/packmgr/service.jsp?cmd=upload' --verbose"
                                                sleep 10
                                                echo "Installing New Commons Package on author"
                                                sh "curl -u admin:Oa=]2Z7u#w@Mkojms*V=mj\\>a -F force=true '${author_url}/crx/packmgr/service.jsp?cmd=inst&name=tetrapak-commons.complete'"
                                                sleep 20
                                                echo "Deactivating Old Commons Package on publish for commons"
                                                sh "curl -u admin:Oa=]2Z7u#w@Mkojms*V=mj\\>a -F path=/etc/packages/tetrapak -F cmd=deactivate '${author_url}/bin/replicate.json'"
                                                sleep 20
                                                echo "Activating new Commons Package on publish"
                                                sh "curl -u admin:Oa=]2Z7u#w@Mkojms*V=mj\\>a -F path=/etc/packages/tetrapak/tetrapak-commons.complete-1.0.0-DEV${deploy_id_number}-SNAPSHOT.zip -F cmd=activate '${author_url}/bin/replicate.json'"
                                                sleep 10
                                                                                                }
                                                                                                if (params.Deploy_Customerhub)
                                                                                                {
                                                echo "Uninstalling Old Package on author for customerhub"
                                                sh "curl -u admin:Oa=]2Z7u#w@Mkojms*V=mj\\>a -F force=true '${author_url}/crx/packmgr/service.jsp?cmd=uninst&name=tetrapak-customerhub.complete'"
                                                sleep 20
                                                echo "Deleting Old Package on author"
                                                sh "curl -u admin:Oa=]2Z7u#w@Mkojms*V=mj\\>a -F force=true '${author_url}/crx/packmgr/service.jsp?cmd=rm&name=tetrapak-customerhub.complete'"
                                                sleep 10
                                                echo "Uploading New Package on author"
                                                sh "curl -u admin:Oa=]2Z7u#w@Mkojms*V=mj\\>a -F name=tetrapak-customerhub.complete -F file=@$workspace@2/tetrapak-customerhub/complete/target/tetrapak-customerhub.complete-1.0.0-DEV${deploy_id_number}-SNAPSHOT.zip -F force=true '${author_url}/crx/packmgr/service.jsp?cmd=upload' --verbose"
                                                sleep 10
                                                echo "Installing New Package on author"
                                                sh "curl -u admin:Oa=]2Z7u#w@Mkojms*V=mj\\>a -F force=true '${author_url}/crx/packmgr/service.jsp?cmd=inst&name=tetrapak-customerhub.complete'"
                                                                                                sleep 20
                                                                                                echo "Deactivating Old Customerhub Package on publish"
                                                sh "curl -u admin:Oa=]2Z7u#w@Mkojms*V=mj\\>a -F path=/etc/packages/tetrapak-customerhub -F cmd=deactivate '${author_url}/bin/replicate.json'"
                                                sleep 20
                                                echo "Activating new Customerhub Package on publish"
                                                sh "curl -u admin:Oa=]2Z7u#w@Mkojms*V=mj\\>a -F path=/etc/packages/tetrapak-customerhub/tetrapak-customerhub.complete-1.0.0-DEV${deploy_id_number}-SNAPSHOT.zip -F cmd=activate '${author_url}/bin/replicate.json'"
                                                sleep 10
                                                                                                }
                                                                                                if (params.Deploy_Publicweb)
                                                                                                {
                                                echo "Uninstalling Old Package on author -- PublicWeb"
                                                sh "curl -u admin:Oa=]2Z7u#w@Mkojms*V=mj\\>a -F force=true '${author_url}/crx/packmgr/service.jsp?cmd=uninst&name=tetrapak-publicweb.complete'"
                                                sleep 20
                                                echo "Deleting Old Package on author"
                                                sh "curl -u admin:Oa=]2Z7u#w@Mkojms*V=mj\\>a -F force=true '${author_url}/crx/packmgr/service.jsp?cmd=rm&name=tetrapak-publicweb.complete'"
                                                sleep 10
                                                echo "Uploading New Package on author"
                                                sh "curl -u admin:Oa=]2Z7u#w@Mkojms*V=mj\\>a -F name=tetrapak-publicweb.complete -F file=@$workspace/tetrapak-publicweb/complete/target/tetrapak-publicweb.complete-1.0.0-DEV${deploy_id_number}-SNAPSHOT.zip -F force=true '${author_url}/crx/packmgr/service.jsp?cmd=upload' --verbose"
                                                sleep 10
                                                echo "Installing New Package on author"
                                                sh "curl -u admin:Oa=]2Z7u#w@Mkojms*V=mj\\>a -F force=true '${author_url}/crx/packmgr/service.jsp?cmd=inst&name=tetrapak-publicweb.complete'"
                                                                                                sleep 20

                                                                                                echo "Deactivating Old PublicWeb Package on publish"
                                                sh "curl -u admin:Oa=]2Z7u#w@Mkojms*V=mj\\>a -F path=/etc/packages/tetrapak-publicweb -F cmd=deactivate '${author_url}/bin/replicate.json'"
                                                sleep 20
                                                echo "Activating new PublicWeb Package on publish"
                                                sh "curl -u admin:Oa=]2Z7u#w@Mkojms*V=mj\\>a -F path=/etc/packages/tetrapak-publicweb/tetrapak-publicweb.complete-1.0.0-DEV${deploy_id_number}-SNAPSHOT.zip -F cmd=activate '${author_url}/bin/replicate.json'"
                                                sleep 10
                                                                                                }
                                                                                        }
                                                                }
                }
         }}

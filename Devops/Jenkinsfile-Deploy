@Library('jenkins-pipeline-library') _
pipeline{

agent {
                node {
                label 'cfe-deploy'
        }
}
parameters {
        choice(name: 'Environment', choices: ['QA', 'STAGE'], description: 'Select the environment')
        
        booleanParam(name: 'Deploy_Commons', defaultValue: false, description: 'Please check in case you want to deploy Commons Module')
        string(name: 'Snapshot Commons', defaultValue: 'SnapshotVersion', description: '')

        booleanParam(name: 'Deploy_CustomerHub', defaultValue: false, description: 'Please check in case you want to Customer Hub Module')
        string(name: 'Snapshot CustomerHub', defaultValue: 'SnapshotVersion', description: '')

        booleanParam(name: 'Deploy_PublicWeb', defaultValue: false, description: 'Please check in case you want to deploy Public Web Module')
        string(name: 'Snapshot PublicWeb', defaultValue: 'SnapshotVersion', description: '')
    }
options {
        buildDiscarder(logRotator(numToKeepStr: '30'))
        disableConcurrentBuilds()
    }
    environment {
        author_url_qa = "https://author1.dev.tetrapak.adobecqms.net"
        author_url_stage = "https://author-tetrapak-stage64a.adobecqms.net"
        publish_url = "http://13.69.73.197:4503"
        password_qa="61wC@9MaChWc55JD]My~a0R@"
        password_Stage="ozf9}n]]A<{W>9*pCLxWV*}>"
        package_name = "tetrapak-complete-package"
        
    }


stages{

stage('Author Deployment and Replication to Publish')
         
                       {
                        steps {
                                                                        script {
                                                                                        if (params.Deploy_Commons)
                                                                                                {
                                                withCredentials([[$class: 'UsernamePasswordMultiBinding', credentialsId: 'tetrapak-artifactory-publish-creds', usernameVariable: 'artifactuser', passwordVariable: 'artifactpassword']])
                                    {
                                      sh "curl -LO -k -u ${artifactuser}:${artifactpassword} https://tetrapak.jfrog.io/tetrapak/libs-release-local/tetrapak/tetrapak-commons.complete/1.0.0-202002071351/tetrapak-commons.complete-1.0.0-202002071351.zip" 
       }
                                                echo "Uninstalling Old Commons Package on author for Commons"
                                                sh "curl -u admin:${password_qa} -F force=true '${author_url_qa}/crx/packmgr/service.jsp?cmd=uninst&name=tetrapak-commons.complete'"
                                                sleep 20
                                                echo "Deleting Old Commons Package on author"
                                                sh "curl -u admin:${password_qa} -F force=true '${author_url_qa}/crx/packmgr/service.jsp?cmd=rm&name=tetrapak-commons.complete'"
                                                sleep 10
                                                echo "Uploading New Commons Package on author"
                                                sh "curl -u admin:${password_qa} -F name=tetrapak-customerhub.complete -F file=@$workspace@2/tetrapak-commons/complete/target/tetrapak-commons.complete-1.0.0-202002071351.zip -F force=true '${author_url_qa}/crx/packmgr/service.jsp?cmd=upload' --verbose"
                                                sleep 10
                                                echo "Installing New Commons Package on author"
                                                sh "curl -u admin:${password_qa} -F force=true '${author_url_qa}/crx/packmgr/service.jsp?cmd=inst&name=tetrapak-commons.complete'"
                                                sleep 20
                                                echo "Deactivating Old Commons Package on publish for commons"
                                                sh "curl -u admin:${password_qa} -F path=/etc/packages/tetrapak -F cmd=deactivate '${author_url_qa}/bin/replicate.json'"
                                                sleep 20
                                                echo "Activating new Commons Package on publish"
                                                sh "curl -u admin:${password_qa} -F path=/etc/packages/tetrapak/tetrapak-commons.complete-1.0.0-202002071351.zip -F cmd=activate '${author_url_qa}/bin/replicate.json'"
                                                sleep 10
                                                                                                }
                                                                                                if (params.Deploy_Customerhub)
                                                                                                {
                                                echo "Uninstalling Old Package on author for customerhub"
                                                sh "curl -u admin:${password_qa} -F force=true '${author_url}/crx/packmgr/service.jsp?cmd=uninst&name=tetrapak-customerhub.complete'"
                                                sleep 20
                                                echo "Deleting Old Package on author"
                                                sh "curl -u admin:${password_qa} -F force=true '${author_url}/crx/packmgr/service.jsp?cmd=rm&name=tetrapak-customerhub.complete'"
                                                sleep 10
                                                echo "Uploading New Package on author"
                                                sh "curl -u admin:${password_qa} -F name=tetrapak-customerhub.complete -F file=@$workspace@2/tetrapak-customerhub/complete/target/tetrapak-customerhub.complete-1.0.0-DEV${deploy_id_number}-SNAPSHOT.zip -F force=true '${author_url}/crx/packmgr/service.jsp?cmd=upload' --verbose"
                                                sleep 10
                                                echo "Installing New Package on author"
                                                sh "curl -u admin:${password_qa} -F force=true '${author_url}/crx/packmgr/service.jsp?cmd=inst&name=tetrapak-customerhub.complete'"
                                                                                                sleep 20
                                                                                                echo "Deactivating Old Customerhub Package on publish"
                                                sh "curl -u admin:${password_qa} -F path=/etc/packages/tetrapak-customerhub -F cmd=deactivate '${author_url}/bin/replicate.json'"
                                                sleep 20
                                                echo "Activating new Customerhub Package on publish"
                                                sh "curl -u admin:${password_qa} -F path=/etc/packages/tetrapak-customerhub/tetrapak-customerhub.complete-1.0.0-DEV${deploy_id_number}-SNAPSHOT.zip -F cmd=activate '${author_url}/bin/replicate.json'"
                                                sleep 10
                                                                                                }
                                                                                                if (params.Deploy_Publicweb)
                                                                                                {
                                                echo "Uninstalling Old Package on author -- PublicWeb"
                                                sh "curl -u admin:${password_qa} -F force=true '${author_url}/crx/packmgr/service.jsp?cmd=uninst&name=tetrapak-publicweb.complete'"
                                                sleep 20
                                                echo "Deleting Old Package on author"
                                                sh "curl -u admin:${password_qa} -F force=true '${author_url}/crx/packmgr/service.jsp?cmd=rm&name=tetrapak-publicweb.complete'"
                                                sleep 10
                                                echo "Uploading New Package on author"
                                                sh "curl -u admin:${password_qa} -F name=tetrapak-publicweb.complete -F file=@$workspace/tetrapak-publicweb/complete/target/tetrapak-publicweb.complete-1.0.0-DEV${deploy_id_number}-SNAPSHOT.zip -F force=true '${author_url}/crx/packmgr/service.jsp?cmd=upload' --verbose"
                                                sleep 10
                                                echo "Installing New Package on author"
                                                sh "curl -u admin:${password_qa} -F force=true '${author_url}/crx/packmgr/service.jsp?cmd=inst&name=tetrapak-publicweb.complete'"
                                                                                                sleep 20

                                                                                                echo "Deactivating Old PublicWeb Package on publish"
                                                sh "curl -u admin:${password_qa} -F path=/etc/packages/tetrapak-publicweb -F cmd=deactivate '${author_url}/bin/replicate.json'"
                                                sleep 20
                                                echo "Activating new PublicWeb Package on publish"
                                                sh "curl -u admin:${password_qa} -F path=/etc/packages/tetrapak-publicweb/tetrapak-publicweb.complete-1.0.0-DEV${deploy_id_number}-SNAPSHOT.zip -F cmd=activate '${author_url}/bin/replicate.json'"
                                                sleep 10
                                                                                                }
                                                                                        }
                                                                }
                }
         }
post {
        always {
            sendNotifications(currentBuild.currentResult)
        }
    }
}

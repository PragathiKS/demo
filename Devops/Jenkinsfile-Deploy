//@Library('smartsales-jenkins-library') _
pipeline {
agent {
                node {
                label 'cfe-deploy'
        }
}
parameters {
        choice(name: 'Environment', choices: ['DEV', 'QA', 'STAGE'], description: 'Select the environment')
        
        booleanParam defaultValue: true, description: 'Plese check in case you want to build Public Web Module', name: 'DeployPublicWeb'
        booleanParam defaultValue: true, description: 'Please check in case you want to build Commons Module', name: 'DeployCommons'
        booleanParam defaultValue: true, description: 'Please check in case you want to build Customer Hub Module', name: 'DeployCustomerHub'

        //booleanParam(name: 'DeployCommons', defaultValue: false, description: 'Please check in case you want to deploy Commons Module')
        string(name: 'Snapshot_Commons', defaultValue: 'SnapshotVersion', description: '')

        //booleanParam(name: 'DeployCustomerHub', defaultValue: false, description: 'Please check in case you want to Customer Hub Module')
        string(name: 'Snapshot_CustomerHub', defaultValue: 'SnapshotVersion', description: '')

        //booleanParam(name: 'DeployPublicWeb', defaultValue: false, description: 'Please check in case you want to deploy Public Web Module')
        string(name: 'Snapshot_PublicWeb', defaultValue: 'SnapshotVersion', description: '')
        

    }
options {
        buildDiscarder(logRotator(numToKeepStr: '30'))
        disableConcurrentBuilds()
    }
    environment {
        // author_url_qa = "https://author1.dev.tetrapak.adobecqms.net"
        author_url_dev = "https://author1.dev.tetrapak.adobecqms.net"
        author_url_qa = "https://author1.test.tetrapak.adobecqms.net"
        author_url_stage = "https://author-tetrapak-stage64a.adobecqms.net"
        publish_url_dev = ""
        publish_url_qa = "https://publish1.test.tetrapak.adobecqms.net"
        publish_url_stage = ""
        // publish_url = "http://13.69.73.197:4503"
        
    }
stages{

stage('Author Deployment and Replication to Publish')
                       {
                        steps {
                            script {

                                            echo "${params.Environment}"
                                            echo "DeployCommons"
                                            echo "${params.DeployCommons}"
                                            echo "DeployCustomerHub"
                                            echo "${params.DeployCustomerHub}"
                                            echo "DeployPublicWeb"
                                            echo "${params.DeployPublicWeb}"
                            }
                            script {
                                if (params.Environment == "QA") {

                                         withCredentials([[$class: 'UsernamePasswordMultiBinding', credentialsId: 'aemcredqa', usernameVariable: 'username_qa', passwordVariable: 'password_qa']])
                                        {
                                        
                                        if (params.DeployCommons)
                                        {


                                            packageName = "tetrapak-commons.complete"
                                            
                                            withCredentials([[$class: 'UsernamePasswordMultiBinding', credentialsId: 'tetrapak-artifactory-publish-creds', usernameVariable: 'artifactuser', passwordVariable: 'artifactpassword']])
                                    {
                                      sh "curl -LO -k -k -u ${artifactuser}:${artifactpassword} https://tetrapak.jfrog.io/tetrapak/libs-snapshot-local/tetrapak/${packageName}/1.0.0-DEV${params.Snapshot_Commons}-SNAPSHOT/${packageName}-1.0.0-DEV${Snapshot_Commons}-SNAPSHOT.zip" 
                                        }
                                                echo "Uninstalling Old Commons Package on author for Commons"
                                                sh "curl -k -u admin:${password_qa} -F force=true '${author_url_qa}/crx/packmgr/service.jsp?cmd=uninst&name=${packageName}'"
                                                sleep 5
                                                echo "Deleting Old Commons Package on author"
                                                sh "curl -k -u admin:${password_qa} -F force=true '${author_url_qa}/crx/packmgr/service.jsp?cmd=rm&name=${packageName}'"
                                                sleep 5
                                                echo "Uploading New Commons Package on author"
                                                sh "curl -k -u admin:${password_qa} -F name=${packageName} -F file=@${packageName}-1.0.0-DEV${params.Snapshot_Commons}-SNAPSHOT.zip -F force=true '${author_url_qa}/crx/packmgr/service.jsp?cmd=upload' --verbose"
                                                sleep 5
                                                echo "Installing New Commons Package on author"
                                                sh "curl -k -u admin:${password_qa} -F force=true '${author_url_qa}/crx/packmgr/service.jsp?cmd=inst&name=${packageName}'"
                                                sleep 5
                                                echo "Deactivating Old Commons Package on publish for commons"
                                                sh "curl -k -u admin:${password_qa} -F path=/etc/packages/tetrapak -F cmd=deactivate '${author_url_qa}/bin/replicate.json'"
                                                sleep 5
                                                echo "Activating new Commons Package on publish"
                                                sh "curl -k -u admin:${password_qa} -F path=/etc/packages/tetrapak/${packageName}-1.0.0-DEV${params.Snapshot_Commons}-SNAPSHOT.zip -F cmd=activate '${author_url_qa}/bin/replicate.json'"
                                                sleep 5
                                                                                                }
                                    if (params.DeployCustomerHub)
                                                
                                                                                              {
                                                 packageName = "tetrapak-customerhub.complete"                                                   
                                            withCredentials([[$class: 'UsernamePasswordMultiBinding', credentialsId: 'tetrapak-artifactory-publish-creds', usernameVariable: 'artifactuser', passwordVariable: 'artifactpassword']])
                                    {
                                      sh "curl -LO -k -k -u ${artifactuser}:${artifactpassword} https://tetrapak.jfrog.io/tetrapak/libs-snapshot-local/tetrapak-customerhub/${packageName}/1.0.0-DEV${params.Snapshot_CustomerHub}-SNAPSHOT/${packageName}-1.0.0-DEV${params.Snapshot_CustomerHub}-SNAPSHOT.zip" 
                                        }       
                                                echo "Uninstalling Old Commons Package on author for Commons"
                                                sh "curl -k -u admin:${password_qa} -F force=true '${author_url_qa}/crx/packmgr/service.jsp?cmd=uninst&name=${packageName}'"
                                                sleep 5
                                                echo "Deleting Old Commons Package on author"
                                                sh "curl -k -u admin:${password_qa} -F force=true '${author_url_qa}/crx/packmgr/service.jsp?cmd=rm&name=${packageName}'"
                                                sleep 5
                                                echo "Uploading New Commons Package on author"
                                                sh "curl -k -u admin:${password_qa} -F name=${packageName} -F file=@${packageName}-1.0.0-DEV${params.Snapshot_CustomerHub}-SNAPSHOT.zip -F force=true '${author_url_qa}/crx/packmgr/service.jsp?cmd=upload' --verbose"
                                                sleep 5
                                                echo "Installing New Commons Package on author"
                                                sh "curl -k -u admin:${password_qa} -F force=true '${author_url_qa}/crx/packmgr/service.jsp?cmd=inst&name=${packageName}'"
                                                sleep 5
                                                echo "Deactivating Old Commons Package on publish for commons"
                                                sh "curl -k -u admin:${password_qa} -F path=/etc/packages/tetrapak -F cmd=deactivate '${author_url_qa}/bin/replicate.json'"
                                                sleep 5
                                                echo "Activating new Commons Package on publish"
                                                sh "curl -k -u admin:${password_qa} -F path=/etc/packages/tetrapak/${packageName}-1.0.0-DEV${params.Snapshot_CustomerHub}-SNAPSHOT.zip -F cmd=activate '${author_url_qa}/bin/replicate.json'"
                                                sleep 5
                                                                                                }
                                    if (params.DeployPublicWeb)   
                                                                                                {
                                                packageName = "tetrapak-publicweb.complete"                                                        
                                            withCredentials([[$class: 'UsernamePasswordMultiBinding', credentialsId: 'tetrapak-artifactory-publish-creds', usernameVariable: 'artifactuser', passwordVariable: 'artifactpassword']])
                                    {
                                      sh "curl -LO -k -k -u ${artifactuser}:${artifactpassword} https://tetrapak.jfrog.io/tetrapak/libs-snapshot-local/tetrapak-publicweb/${packageName}/1.0.0-DEV${params.Snapshot_PublicWeb}-SNAPSHOT/${packageName}-1.0.0-DEV${params.Snapshot_PublicWeb}-SNAPSHOT.zip" 
                                        }
                                                echo "Uninstalling Old Commons Package on author for Commons"
                                                sh "curl -k -u admin:${password_qa} -F force=true '${author_url_qa}/crx/packmgr/service.jsp?cmd=uninst&name=${packageName}'"
                                                sleep 5
                                                echo "Deleting Old Commons Package on author"
                                                sh "curl -k -u admin:${password_qa} -F force=true '${author_url_qa}/crx/packmgr/service.jsp?cmd=rm&name=${packageName}'"
                                                sleep 5
                                                echo "Uploading New Commons Package on author"
                                                sh "curl -k -u admin:${password_qa} -F name=${packageName} -F file=@${packageName}-1.0.0-DEV${params.Snapshot_PublicWeb}-SNAPSHOT.zip -F force=true '${author_url_qa}/crx/packmgr/service.jsp?cmd=upload' --verbose"
                                                sleep 5
                                                echo "Installing New Commons Package on author"
                                                sh "curl -k -u admin:${password_qa} -F force=true '${author_url_qa}/crx/packmgr/service.jsp?cmd=inst&name=${packageName}'"
                                                sleep 5
                                                echo "Deactivating Old Commons Package on publish for commons"
                                                sh "curl -k -u admin:${password_qa} -F path=/etc/packages/tetrapak -F cmd=deactivate '${author_url_qa}/bin/replicate.json'"
                                                sleep 5
                                                echo "Activating new Commons Package on publish"
                                                sh "curl -k -u admin:${password_qa} -F path=/etc/packages/tetrapak/${packageName}-1.0.0-DEV${params.Snapshot_PublicWeb}-SNAPSHOT.zip -F cmd=activate '${author_url_qa}/bin/replicate.json'"
                                                sleep 5
                                                                                                }
                                                                                        }
                                }
                            }
                            script {
                            if (params.Environment == "DEV") {

                                withCredentials([[$class: 'UsernamePasswordMultiBinding', credentialsId: 'aemcreddev', usernameVariable: 'username_qa', passwordVariable: 'password_dev']])
                                        {

                                    if (params.DeployCommons)
                                            {
                                                packageName = "tetrapak-commons.complete"
                                        withCredentials([[$class: 'UsernamePasswordMultiBinding', credentialsId: 'tetrapak-artifactory-publish-creds', usernameVariable: 'artifactuser', passwordVariable: 'artifactpassword']])
                                        
                                            {
                                        sh "curl -LO -k -k -u ${artifactuser}:${artifactpassword} https://tetrapak.jfrog.io/tetrapak/libs-snapshot-local/tetrapak/${packageName}/1.0.0-DEV${params.Snapshot_Commons}-SNAPSHOT/${packageName}-1.0.0-DEV${Snapshot_Commons}-SNAPSHOT.zip" 

                                                 }
                                                echo "Uninstalling Old Commons Package on author for Commons"
                                                sh "curl -k -u admin:${password_dev} -F force=true '${author_url_dev}/crx/packmgr/service.jsp?cmd=uninst&name=${packageName}'"
                                                sleep 5
                                                echo "Deleting Old Commons Package on author"
                                                sh "curl -k -u admin:${password_dev} -F force=true '${author_url_dev}/crx/packmgr/service.jsp?cmd=rm&name=${packageName}'"
                                                sleep 5
                                                echo "Uploading New Commons Package on author"
                                                sh "curl -k -u admin:${password_dev} -F name=${packageName} -F file=@${packageName}-1.0.0-DEV${params.Snapshot_Commons}-SNAPSHOT.zip -F force=true '${author_url_dev}/crx/packmgr/service.jsp?cmd=upload' --verbose"
                                                sleep 5
                                                echo "Installing New Commons Package on author"
                                                sh "curl -k -u admin:${password_dev} -F force=true '${author_url_dev}/crx/packmgr/service.jsp?cmd=inst&name=${packageName}'"
                                                sleep 5
                                                echo "Deactivating Old Commons Package on publish for commons"
                                                sh "curl -k -u admin:${password_dev} -F path=/etc/packages/tetrapak -F cmd=deactivate '${author_url_dev}/bin/replicate.json'"
                                                sleep 5
                                                echo "Activating new Commons Package on publish"
                                                sh "curl -k -u admin:${password_dev} -F path=/etc/packages/tetrapak/${packageName}-1.0.0-DEV${params.Snapshot_Commons}-SNAPSHOT.zip -F cmd=activate '${author_url_dev}/bin/replicate.json'"
                                                sleep 5
                                                                                                }
                                    if (params.DeployCustomerHub)
                                                        {
                                                 packageName = "tetrapak-customerhub.complete"                                                   
                                            withCredentials([[$class: 'UsernamePasswordMultiBinding', credentialsId: 'tetrapak-artifactory-publish-creds', usernameVariable: 'artifactuser', passwordVariable: 'artifactpassword']])
                                    {
                                      sh "curl -LO -k -k -u ${artifactuser}:${artifactpassword} https://tetrapak.jfrog.io/tetrapak/libs-snapshot-local/tetrapak-customerhub/${packageName}/1.0.0-DEV${params.Snapshot_CustomerHub}-SNAPSHOT/${packageName}-1.0.0-DEV${params.Snapshot_CustomerHub}-SNAPSHOT.zip" 
                                        }       
                                                echo "Uninstalling Old Commons Package on author for Commons"
                                                sh "curl -k -u admin:${password_dev} -F force=true '${author_url_dev}/crx/packmgr/service.jsp?cmd=uninst&name=${packageName}'"
                                                sleep 5
                                                echo "Deleting Old Commons Package on author"
                                                sh "curl -k -u admin:${password_dev} -F force=true '${author_url_dev}/crx/packmgr/service.jsp?cmd=rm&name=${packageName}'"
                                                sleep 5
                                                echo "Uploading New Commons Package on author"
                                                sh "curl -k -u admin:${password_dev} -F name=${packageName} -F file=@${packageName}-1.0.0-DEV${params.Snapshot_CustomerHub}-SNAPSHOT.zip -F force=true '${author_url_dev}/crx/packmgr/service.jsp?cmd=upload' --verbose"
                                                sleep 5
                                                echo "Installing New Commons Package on author"
                                                sh "curl -k -u admin:${password_dev} -F force=true '${author_url_dev}/crx/packmgr/service.jsp?cmd=inst&name=${packageName}'"
                                                sleep 5
                                                echo "Deactivating Old Commons Package on publish for commons"
                                                sh "curl -k -u admin:${password_dev} -F path=/etc/packages/tetrapak -F cmd=deactivate '${author_url_dev}/bin/replicate.json'"
                                                sleep 5
                                                echo "Activating new Commons Package on publish"
                                                sh "curl -k -u admin:${password_dev} -F path=/etc/packages/tetrapak/${packageName}-1.0.0-DEV${params.Snapshot_CustomerHub}-SNAPSHOT.zip -F cmd=activate '${author_url_dev}/bin/replicate.json'"
                                                sleep 5
                                                                                                }                                    
                                    if (params.DeployPublicWeb)
                                                                                                                                                                                    {
                                                packageName = "tetrapak-publicweb.complete"                                                        
                                            withCredentials([[$class: 'UsernamePasswordMultiBinding', credentialsId: 'tetrapak-artifactory-publish-creds', usernameVariable: 'artifactuser', passwordVariable: 'artifactpassword']])
                                    {
                                      sh "curl -LO -k -k -u ${artifactuser}:${artifactpassword} https://tetrapak.jfrog.io/tetrapak/libs-snapshot-local/tetrapak-publicweb/${packageName}/1.0.0-DEV${params.Snapshot_PublicWeb}-SNAPSHOT/${packageName}-1.0.0-DEV${params.Snapshot_PublicWeb}-SNAPSHOT.zip" 
                                        }
                                                echo "Uninstalling Old Commons Package on author for Commons"
                                                sh "curl -k -u admin:${password_dev} -F force=true '${author_url_dev}/crx/packmgr/service.jsp?cmd=uninst&name=${packageName}'"
                                                sleep 5
                                                echo "Deleting Old Commons Package on author"
                                                sh "curl -k -u admin:${password_dev} -F force=true '${author_url_dev}/crx/packmgr/service.jsp?cmd=rm&name=${packageName}'"
                                                sleep 5
                                                echo "Uploading New Commons Package on author"
                                                sh "curl -k -u admin:${password_dev} -F name=${packageName} -F file=@${packageName}-1.0.0-DEV${params.Snapshot_PublicWeb}-SNAPSHOT.zip -F force=true '${author_url_dev}/crx/packmgr/service.jsp?cmd=upload' --verbose"
                                                sleep 5
                                                echo "Installing New Commons Package on author"
                                                sh "curl -k -u admin:${password_dev} -F force=true '${author_url_dev}/crx/packmgr/service.jsp?cmd=inst&name=${packageName}'"
                                                sleep 5
                                                echo "Deactivating Old Commons Package on publish for commons"
                                                sh "curl -k -u admin:${password_dev} -F path=/etc/packages/tetrapak -F cmd=deactivate '${author_url_dev}/bin/replicate.json'"
                                                sleep 5
                                                echo "Activating new Commons Package on publish"
                                                sh "curl -k -u admin:${password_dev} -F path=/etc/packages/tetrapak/${packageName}-1.0.0-DEV${params.Snapshot_PublicWeb}-SNAPSHOT.zip -F cmd=activate '${author_url_dev}/bin/replicate.json'"
                                                sleep 5
                                                                                                }                                                                                                                                               
                                    }
                            }
                            }
                            script {
                                if (params.Environment == "STAGE") {

                                withCredentials([[$class: 'UsernamePasswordMultiBinding', credentialsId: 'aemcredstage', usernameVariable: 'username_qa', passwordVariable: 'password_stage']])
                                        {

                                    if (params.DeployCommons)
                                            {
                                                packageName = "tetrapak-commons.complete"
                                        withCredentials([[$class: 'UsernamePasswordMultiBinding', credentialsId: 'tetrapak-artifactory-publish-creds', usernameVariable: 'artifactuser', passwordVariable: 'artifactpassword']])
                                            {
                                        sh "curl -LO -k -k -u ${artifactuser}:${artifactpassword} https://tetrapak.jfrog.io/tetrapak/libs-release-local/tetrapak/${packageName}/1.0.0-${params.Snapshot_Commons}/${packageName}-1.0.0-${params.Snapshot_Commons}.zip" 
                                                 }
                                                echo "Uninstalling Old Commons Package on author for Commons"
                                                sh "curl -k -u admin:${password_stage} -F force=true '${author_url_stage}/crx/packmgr/service.jsp?cmd=uninst&name=${packageName}'"
                                                sleep 20
                                                echo "Deleting Old Commons Package on author"
                                                sh "curl -k -u admin:${password_stage} -F force=true '${author_url_stage}/crx/packmgr/service.jsp?cmd=rm&name=${packageName}'"
                                                sleep 10
                                                echo "Uploading New Commons Package on author"
                                                sh "curl -k -u admin:${password_stage} -F name=${packageName} -F file=@${packageName}-1.0.0-${params.Snapshot_Commons}.zip -F force=true '${author_url_stage}/crx/packmgr/service.jsp?cmd=upload' --verbose"
                                                sleep 10
                                                echo "Installing New Commons Package on author"
                                                sh "curl -k -u admin:${password_stage} -F force=true '${author_url_stage}/crx/packmgr/service.jsp?cmd=inst&name=${packageName}'"
                                                sleep 20
                                                echo "Deactivating Old Commons Package on publish for commons"
                                                sh "curl -k -u admin:${password_stage} -F path=/etc/packages/tetrapak -F cmd=deactivate '${author_url_stage}/bin/replicate.json'"
                                                sleep 20
                                                echo "Activating new Commons Package on publish"
                                                sh "curl -k -u admin:${password_stage} -F path=/etc/packages/tetrapak/${packageName}-1.0.0-${params.Snapshot_Commons}.zip -F cmd=activate '${author_url_stage}/bin/replicate.json'"
                                                sleep 10
                                                                                                }
                                    if (params.DeployCustomerHub)
                                                                                                {
                                                    packageName = "tetrapak-customerhub.complete"                                                
                                                echo "Uninstalling Old Package on author for customerhub"
                                                sh "curl -k -u admin:${password_stage} -F force=true '${author_url_stage}/crx/packmgr/service.jsp?cmd=uninst&name=${packageName}'"
                                                sleep 20
                                                echo "Deleting Old Package on author"
                                                sh "curl -k -u admin:${password_stage} -F force=true '${author_url_stage}/crx/packmgr/service.jsp?cmd=rm&name=${packageName}'"
                                                sleep 10
                                                echo "Uploading New Package on author"
                                                sh "curl -k -u admin:${password_stage} -F name=${packageName} -F file=@$workspace@2/tetrapak-customerhub/complete/target/${packageName}-1.0.0-DEV${deploy_id_number}-SNAPSHOT.zip -F force=true '${author_url_stage}/crx/packmgr/service.jsp?cmd=upload' --verbose"
                                                sleep 10
                                                echo "Installing New Package on author"
                                                sh "curl -k -u admin:${password_stage} -F force=true '${author_url_stage}/crx/packmgr/service.jsp?cmd=inst&name=${packageName}'"
                                                                                                sleep 20
                                                                                                echo "Deactivating Old Customerhub Package on publish"
                                                sh "curl -k -u admin:${password_stage} -F path=/etc/packages/tetrapak-customerhub -F cmd=deactivate '${author_url_stage}/bin/replicate.json'"
                                                sleep 20
                                                echo "Activating new Customerhub Package on publish"
                                                sh "curl -k -u admin:${password_stage} -F path=/etc/packages/tetrapak-customerhub/${packageName}-1.0.0-DEV${deploy_id_number}-SNAPSHOT.zip -F cmd=activate '${author_url_stage}/bin/replicate.json'"
                                                sleep 10
                                                                                                }
                                    if (params.DeployPublicWeb)
                                                                                                {
                                                    packageName = "tetrapak-publicweb.complete"                                                
                                                echo "Uninstalling Old Package on author -- PublicWeb"
                                                sh "curl -k -u admin:${password_stage} -F force=true '${author_url_stage}/crx/packmgr/service.jsp?cmd=uninst&name=${packageName}'"
                                                sleep 20
                                                echo "Deleting Old Package on author"
                                                sh "curl -k -u admin:${password_stage} -F force=true '${author_url_stage}/crx/packmgr/service.jsp?cmd=rm&name=${packageName}'"
                                                sleep 10
                                                echo "Uploading New Package on author"
                                                sh "curl -k -u admin:${password_stage} -F name=${packageName} -F file=@$workspace/tetrapak-publicweb/complete/target/${packageName}-1.0.0-DEV${deploy_id_number}-SNAPSHOT.zip -F force=true '${author_url_stage}/crx/packmgr/service.jsp?cmd=upload' --verbose"
                                                sleep 10
                                                echo "Installing New Package on author"
                                                sh "curl -k -u admin:${password_stage} -F force=true '${author_url_stage}/crx/packmgr/service.jsp?cmd=inst&name=${packageName}'"
                                                                                                sleep 20

                                                echo "Deactivating Old PublicWeb Package on publish"
                                                sh "curl -k -u admin:${password_stage} -F path=/etc/packages/tetrapak-publicweb -F cmd=deactivate '${author_url_stage}/bin/replicate.json'"
                                                sleep 20
                                                echo "Activating new PublicWeb Package on publish"
                                                sh "curl -k -u admin:${password_stage} -F path=/etc/packages/tetrapak-publicweb/${packageName}-1.0.0-DEV${deploy_id_number}-SNAPSHOT.zip -F cmd=activate '${author_url_stage}/bin/replicate.json'"
                                                sleep 10
                                                                                                }
                                                                                                                             
                            }    
                                    }
                                      
                                                                }
                }
         }
/****post {
        always {
            sendNotifications(currentBuild.currentResult)
        }
    }****/
}
}
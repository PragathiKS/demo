@Library('jenkins-pipeline-library') _

pipeline {
    agent {
        node {
            label 'cfe-deploy'
        }
    }
    
    parameters {
        booleanParam (defaultValue: false, description: 'Please check in case you want to build Commons Module', name: 'Build_Commons')
        booleanParam (defaultValue: false, description: 'Please check in case you want to build Public Web Module', name: 'Build_Publicweb')
        booleanParam (defaultValue: false, description: 'Please check in case you want to build My Tetra Pak Module', name: 'Build_MyTetraPak')
	    booleanParam (defaultValue: false, description: 'Please check in case you want to build My Tetra Pak Module', name: 'Build_Tetralaval')
	    booleanParam (defaultValue: false, description: 'Please check in case you want to build Supplierportal Module', name: 'Build_Supplierportal')
        string (description: "Type in branch name (e.g. release/develop-***)", name: 'Build_Branch', trim: true)
    }

    options {
        buildDiscarder(logRotator(numToKeepStr: '10'))
        disableConcurrentBuilds()
        parallelsAlwaysFailFast()
        office365ConnectorWebhooks([[
            name: 'Office 365',
            startNotification: true,
            url: "https://tetrapak.webhook.office.com/webhookb2/53b8ede5-b02a-49e6-9ed1-5086cb59ca39@d2d2794a-61cc-4823-9690-8e288fd554cc/IncomingWebhook/178ca49866bd49ffa589e2339c07fe64/fa27bbed-fdda-4ecd-97e8-d8f572ab24d1"
        ]])
    }

    environment {
        build_id_number = ""
    }

    stages {
        stage('init-build-Number') {
            steps {
                script {
                    def now = new Date()
                    def formattedDate
                    formattedDate = now.format("yyyyMMddHHmm")
                    build_id_number = formattedDate
                    echo "build_id_number = ${build_id_number}"
		        }
            }
        }

        stage('Build Stage Artifact') {
            agent {
                dockerfile {
                    args "-v ${env.HOME}/.m2:/root/.m2    --tmpfs /.npm -u root:root"
                    label 'cfe-deploy'
                    reuseNode true
                }
            }

            steps {
                script {
                    if (params.Build_Commons) {
                        appname = "commons"
                        buildandsonar()
                    }
                    else {
					    dir('tetrapak-commons') {
					        sh "npm install --prefix ui.dev/src"
                            sh "npm rebuild node-sass"
						}
					}
                }

                script {
                    if (params.Build_MyTetraPak) {
                        appname = "customerhub"
                        buildandsonar()
                    }
                }

                script {
                    if (params.Build_Publicweb) {
                        appname = "publicweb"
                        buildandsonar()
                    }
			        else {
                        dir('tetrapak-publicweb') {
                            sh "npm install --prefix ui.dev/src"
                        }
                    }
                }

                script {
                        if (params.Build_Tetralaval) {
                            appname = "tetra-laval"
                            buildandsonarlaval()
                        }
                }

                script {
                    if (params.Build_Supplierportal) {
                        appname = "supplierportal"
                        buildandsonar()
                    }
                }
            }
        }
        stage('Author and Publisher Deployment') {
            steps {
                script {
                    author_url = "https://author1westeurope.stage65.tetrapak.adobecqms.net"
                    stagedeployment()
                }
            }
        }
        stage('Stage Cache Clear') {
            steps {
                script {
                    cacheflush()
                }
            }
        }
    }
    
    post {
        always {
            sendNotifications(currentBuild.currentResult)
        }
        cleanup {
            sh label: "clean log4j from .m2 cache", script: "sudo rm -rf ~/.m2/repository/log4j/*"
            cleanWs deleteDirs: true, disableDeferredWipeout: true, notFailBuild: true
        }
    }
}
    def buildandsonar() {
        echo "Build ${appname}"
        dir("tetrapak-${appname}") {
            sh "rm -rf ui.dev/src/node_modules && rm -rf ui.dev/src/package-lock.json"
            sh "npm cache clean --force"                    
            withCredentials([[$class: 'UsernamePasswordMultiBinding', credentialsId: 'tetrapak-artifactory-publish-creds', usernameVariable: 'artifactuser', passwordVariable: 'artifactpassword']])
            {
                sh "mvn clean -s settings.xml -Dartuser=${artifactuser} -Dartpassword=${artifactpassword} install deploy -Pminify -Dbuildversion=1.0.0-${build_id_number}"
            }
        }
    }
    def buildandsonarlaval() {
        echo "Build ${appname}"
        dir("${appname}") {
            sh "rm -rf ui.frontend/node_modules && rm -rf ui.frontend/package-lock.json"
            sh "npm cache clean --force"
            withCredentials([[$class: 'UsernamePasswordMultiBinding', credentialsId: 'tetrapak-artifactory-publish-creds', usernameVariable: 'artifactuser', passwordVariable: 'artifactpassword']])
            {
                sh "mvn clean -s settings.xml -Dartuser=${artifactuser} -Dartpassword=${artifactpassword} install deploy -Pminify -Dbaseline.skip=true -Dbuildversion=1.0.0-${build_id_number}"
            }
        }
    }
   
    def stagedeployment() {
        if (params.Build_Commons)    {
            packageName = "tetrapak-commons.complete"
            repoName = "tetrapak"
            fileName = "1.0.0-${build_id_number}"
            prodartifactdownload()                
            parallel (
                "Author Commons" : {                                    
                    authordeploy()
                },
                "Publisher Commons" : {                  
                    publish_url = "https://publish1westeurope.stage65.tetrapak.adobecqms.net"
                    publishdeploy()
                                       
                    publish_url = "https://publish2westeurope.stage65.tetrapak.adobecqms.net"
                    publishdeploy()
                }
            )
        }

        if (params.Build_MyTetraPak) {
            packageName = "tetrapak-customerhub.complete"
            repoName = "tetrapak-customerhub"                
            fileName = "1.0.0-${build_id_number}"                  
            prodartifactdownload()                   
            parallel (
                "Author MyTetrapak" : {                               
                    authordeploy()
                },
                "Publisher MyTetrapak" : {                      
                    publish_url = "https://publish1westeurope.stage65.tetrapak.adobecqms.net"
                    publishdeploy()
                                            
                    publish_url = "https://publish2westeurope.stage65.tetrapak.adobecqms.net"
                    publishdeploy()                           
                }
            )
        }
	
        if (params.Build_Supplierportal) {
            packageName = "tetrapak-supplierportal.complete"
            repoName = "tetrapak-supplierportal"
            fileName = "1.0.0-${build_id_number}"
            prodartifactdownload()
            parallel (
                "Author Supplierportal" : {
                    authordeploy()
                },
                "Publisher Supplierportal" : {
                    publish_url = "https://publish1westeurope.stage65.tetrapak.adobecqms.net"
                    publishdeploy()

                    publish_url = "https://publish2westeurope.stage65.tetrapak.adobecqms.net"
                    publishdeploy()
                }
            )
        }

        if (params.Build_Publicweb) {
                packageName = "tetrapak-publicweb.complete"
                repoName = "tetrapak-publicweb"
                fileName = "1.0.0-${build_id_number}"
                prodartifactdownload()
                parallel (
                    "Author PublicWeb" : {                               
                        authordeploy()
                    },
                    "Publisher PublicWeb" : {                  
                        publish_url = "https://publish1westeurope.stage65.tetrapak.adobecqms.net"
                        publishdeploy() 

                        publish_url = "https://publish2westeurope.stage65.tetrapak.adobecqms.net"
                        publishdeploy()
                    }
                )                
            }
	    if (params.Build_Tetralaval) {
                packageName = "tetrapak-tetralaval.all"
                repoName = "tetrapak-tetralaval"
                fileName = "1.0.0-${build_id_number}"
                prodartifactdownload()
                parallel (
                    "Author Tetralaval" : {
                        authordeploy()
                    },
                    "Publisher Tetralaval" : {
                        publish_url = "https://publish1westeurope.stage65.tetrapak.adobecqms.net"
                        publishdeploy()
                        
                        publish_url = "https://publish2westeurope.stage65.tetrapak.adobecqms.net"
                        publishdeploy()
                    }
                )
        }
    } 
       
    def prodartifactdownload() {
        withCredentials([[$class: 'UsernamePasswordMultiBinding', credentialsId: 'tetrapak-artifactory-publish-creds', usernameVariable: 'artifactuser', passwordVariable: 'artifactpassword']])
        {
            sh "curl -LO -k -k -u ${artifactuser}:${artifactpassword} https://tetrapak.jfrog.io/tetrapak/libs-release-local/${repoName}/${packageName}/${fileName}/${packageName}-${fileName}.zip"
            echo "https://tetrapak.jfrog.io/tetrapak/libs-release-local/${repoName}/${packageName}/${fileName}/${packageName}-${fileName}.zip"

        }
    }   

    def authordeploy() {
        withCredentials([[$class: 'UsernamePasswordMultiBinding', credentialsId: 'sapient-user', usernameVariable: 'username', passwordVariable: 'password']])
        {
            sh label: 'Uninstalling Old Package on author', script: "curl -k -u ${username}:${password} -F force=true '${author_url}/crx/packmgr/service.jsp?cmd=uninst&name=${packageName}&group=${repoName}' && sleep 60"
            sh label: "Deleting Old Package on author", script: "curl -k -u ${username}:${password} -F force=true '${author_url}/crx/packmgr/service.jsp?cmd=rm&name=${packageName}&group=${repoName}' && sleep 60"            
            sh label: "Uploading New Package on author", script: "curl -k -u ${username}:${password} -F name=${packageName} -F file=@${packageName}-${fileName}.zip -F force=true '${author_url}/crx/packmgr/service.jsp?cmd=upload' --verbose && sleep 60"
            sh label: "Installing New Package on author", script: "curl -k -u ${username}:${password} -F force=true '${author_url}/crx/packmgr/service.jsp?cmd=inst&name=${packageName}&group=${repoName}' && sleep 60"
        }
    }

    def publishdeploy() {
        withCredentials([[$class: 'UsernamePasswordMultiBinding', credentialsId: 'sapient-user', usernameVariable: 'username', passwordVariable: 'password']])
        {
            sh label: "Uninstalling Old Package on publish", script: "curl -k -u ${username}:${password} -F force=true '${publish_url}/crx/packmgr/service.jsp?cmd=uninst&name=${packageName}&group=${repoName}' && sleep 60"
            sh label: "Deleting Old Package on publish", script: "curl -k -u ${username}:${password} -F force=true '${publish_url}/crx/packmgr/service.jsp?cmd=rm&name=${packageName}&group=${repoName}'  && sleep 60"
            sh label: "Uploading New Package on publish", script: "curl -k -u ${username}:${password} -F name=${packageName} -F file=@${packageName}-${fileName}.zip -F force=true '${publish_url}/crx/packmgr/service.jsp?cmd=upload' --verbose  && sleep 60"
            sh label: "Installing New Package on publish", script: "curl -k -u ${username}:${password} -F force=true '${publish_url}/crx/packmgr/service.jsp?cmd=inst&name=${packageName}&group=${repoName}'  && sleep 60"
        }
    }

    def cacheflush() {
        build job: 'CFE/CFE-HTTPD-Cache-Flush', parameters: [string(name: 'ENVIRONMENT', value: 'STAGE')], wait: true

        build job: 'CFE/CFE-Cdn-Cache', parameters: [string(name: 'Environment', value: 'STAGE'), booleanParam(name: 'Publicweb', value: params.Build_Publicweb), booleanParam(name: 'Customerhub', value: params.Build_MyTetraPak), booleanParam(name: 'Brandsource', value: false), booleanParam(name: 'Tetralaval', value: params.Build_Tetralaval), booleanParam(name: 'Supplierportal', value: params.Build_Supplierportal)], wait: true 
    }

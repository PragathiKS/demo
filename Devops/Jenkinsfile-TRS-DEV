pipeline {
    agent {
        node {
        label 'cfe-deploy'
        }
    }
    
    parameters {
        booleanParam defaultValue: true, description: 'Please check in case you want to build Commons Module', name: 'Build_TRS'
        booleanParam defaultValue: true, description: 'Please uncheck in case you do not want to perform sonar analysis', name: 'Sonar_Analysis'
    }

    options {
        buildDiscarder(logRotator(numToKeepStr: '30'))
        disableConcurrentBuilds()
    }

    environment {
		author_url = "https://author1westeurope.dev65.tetrapak.adobecqms.net"
        build_id_number = ""
        sonar_url = "https://sonarcloud.io"
        login_token = "2354fbb990d5494aad3c578f2c9dd65147d01e02"        
    }

    stages {
        stage('init-build-Number') {
            steps {
                script {
                    def now = new Date()
                    def formattedDate
                    formattedDate = now.format("yyyyMMddHHmm")
                    build_id_number = formattedDate
                    echo "build_id_number = ${build_id_number}-SNAPSHOT"

		}
            }
        }

        stage('Package Build') {

            agent {
                dockerfile {
                    args "-v ${env.HOME}/.m2:/root/.m2    --tmpfs /.npm -u root:root"
                    label 'cfe-deploy'
                }
            }

            steps {
                script {
                    if (params.Build_TRS) {
                        appname = "trs"
                        build()
                    }
                }
            }
        }
		
        stage('Author and Publisher Deployment') {
            agent {
                node {
                label 'cfe-deploy'
            } 
            }
            steps {
                script {
                author_url = "https://author1westeurope.dev65.tetrapak.adobecqms.net"
                publish_url = "https://publish1westeurope.dev65.tetrapak.adobecqms.net"                        
                withCredentials([[$class: 'UsernamePasswordMultiBinding', credentialsId: 'aemcreddev', usernameVariable: 'username', passwordVariable: 'password']])
             {
                 devdeployment()
                 
             }
                }
            }

        }
        stage('Dev Cache Clear') {
            agent {
                node {
                label 'cfe-deploy'
            }
            }
            steps {
                script {
                    cacheflush()
                }
            }
        }		
}

}
    def build() {
                echo "Build TRS"
                dir("training-services") {
                sh "rm -rf ui.dev/src/node_modules && rm -rf ui.dev/src/package-lock.json"
                sh "npm cache clean --force"                    
                    withCredentials([[$class: 'UsernamePasswordMultiBinding', credentialsId: 'tetrapak-artifactory-publish-creds', usernameVariable: 'artifactuser', passwordVariable: 'artifactpassword']])
                    {                       
                sh "mvn clean -s settings.xml -Dartuser=${artifactuser} -Dartpassword=${artifactpassword} install deploy -Pminify -Dbuildversion=1.0.0-DEV${build_id_number}-SNAPSHOT"
				//sh "mvn clean install -Dbuildversion=1.0.0-DEV${build_id_number}-SNAPSHOT"
                  }
                if (!params.Sonar_Analysis) {
                    echo "Skipping Sonar execution for customerhub module"
                } else {
                    sh "mvn sonar:sonar -Dsonar.organization=tetrapak-smartsales   -Dsonar.host.url=${sonar_url} -Dsonar.buildbreaker.skip=true -Dsonar.login=${login_token} -Dsonar.branch=tetrapack-${appname}  -Dsonar.languages=java,js,css  -Dsonar.test.exclusions=**/core/src/test/**  -Dbuildversion=${build_id_number}-SNAPSHOT"
                }                
				}
    }

    def devartifactdownload() {
        withCredentials([[$class: 'UsernamePasswordMultiBinding', credentialsId: 'tetrapak-artifactory-publish-creds', usernameVariable: 'artifactuser', passwordVariable: 'artifactpassword']])
        {
                sh "curl -LO -k -k -u ${artifactuser}:${artifactpassword} https://tetrapak.jfrog.io/tetrapak/libs-snapshot-local/${repoName}/${packageName}/${fileName}/${packageName}-${fileName}.zip"
                echo "https://tetrapak.jfrog.io/tetrapak/libs-snapshot-local/${repoName}/${packageName}/${fileName}/${packageName}-${fileName}.zip"
        }
    }

    def devdeployment() {
        if (params.Build_TRS)  {
                packageName = "tetrapak-trs.all"
                repoName = "tetrapak-trs"
                fileName = "1.0.0-DEV${build_id_number}-SNAPSHOT"
                devartifactdownload()
                parallel (
                    "Author TRS" : {
                authordeploy()
                    },
                    "Publisher TRS" : {
                publishdeploy()
                    }
                )
            }
        }
	
    def authordeploy() {
                
                echo "Uninstalling Old Package on author"
                sh "curl -k -u ${username}:${password} -F force=true '${author_url}/crx/packmgr/service.jsp?cmd=uninst&name=${packageName}'"
                sleep 60
                echo "Deleting Old Package on author"
                sh "curl -k -u ${username}:${password} -F force=true '${author_url}/crx/packmgr/service.jsp?cmd=rm&name=${packageName}'"
                sleep 60
                echo "Uploading New Package on author"
                sh "curl -k -u ${username}:${password} -F name=${packageName} -F file=@${packageName}-${fileName}.zip -F force=true '${author_url}/crx/packmgr/service.jsp?cmd=upload' --verbose"
                sleep 60
                echo "Installing New Package on author"
                sh "curl -k -u ${username}:${password} -F force=true '${author_url}/crx/packmgr/service.jsp?cmd=inst&name=${packageName}'"
                sleep 60
    }

    def publishdeploy() {
                
                echo "Uninstalling Old Package on publish"
                sh "curl -k -u ${username}:${password} -F force=true '${publish_url}/crx/packmgr/service.jsp?cmd=uninst&name=${packageName}'"
                sleep 60
                echo "Deleting Old Package on publish"
                sh "curl -k -u ${username}:${password} -F force=true '${publish_url}/crx/packmgr/service.jsp?cmd=rm&name=${packageName}'"
                sleep 60
                echo "Uploading New Package on publish"
                sh "curl -k -u ${username}:${password} -F name=${packageName} -F file=@${packageName}-${fileName}.zip -F force=true '${publish_url}/crx/packmgr/service.jsp?cmd=upload' --verbose"
                sleep 60
                echo "Installing New Package on publish"
                sh "curl -k -u ${username}:${password} -F force=true '${publish_url}/crx/packmgr/service.jsp?cmd=inst&name=${packageName}'"
                sleep 60
    }

    def cacheflush() {
                echo "Starting Dev Dispatcher Cache Clear"
                withCredentials([sshUserPrivateKey(credentialsId: 'cacheFlushDev', keyFileVariable: 'SSHKEY', passphraseVariable: '', usernameVariable: 'SSHUSER')])
                {
                sh 'ssh -o "StrictHostKeyChecking=no" -i ${SSHKEY} 40.113.160.27 -l tetrapak -tt "sh -x /usr/local/bin/cache_clear.sh"'
                }        
    }
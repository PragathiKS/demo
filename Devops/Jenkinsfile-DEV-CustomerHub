pipeline {
        agent { label "master" } 
/*
 triggers {
          cron('30 10,15 * * *')
		}
		*/
        parameters {
                booleanParam defaultValue: false, description: 'Please check in case you do not want to run the pipeline with all Tools execution', name: 'Skip_Tool_Execution'
        }

        tools {
        maven 'maven'
        jdk 'jdk8'
    }

        environment {
                sonar_url = "http://127.0.0.1:9000"
                author_url = "http://13.69.79.81:4502"
                publish_url = "http://13.69.73.197:4503"
                package_name = "tetrapak-complete-package"
				test_url = "http://tetrapak-dev64a.adobecqms.net/content/tetrapak/customerhubtools/global/en/dashboard.html"
				test_url_pally_zap = "http://tetrapak-dev64a.adobecqms.net/content/tetrapak/customerhubtools/global/en/dashboard.html"
                karmapath =  "${workspace}/tetrapak-customerhub/ui.dev/src/coverage"
        }

        stages {
                stage ('Initialize') {
                        steps {
                                sh      '''
                                        echo "PATH = ${PATH}"
                                        echo "M2_HOME = ${M2_HOME}"
                                        '''
            }
        }			
				
                    stage ( 'Karma, Pa11y, Zap Tools Execution for CustomerHub') {
                        steps {
                                script {
										                if (params.Skip_Tool_Execution) {
                                                                echo "Skipping TOOLS Execution"
														 }
										else {
                                                        echo "Starting pa11y test Run on CustomerHub Urls"
                                                         sh 'chmod 777 Devops/PallyReporting.sh'
                                                         sh './Devops/PallyReporting.sh'
                                                         publishHTML([allowMissing: false, alwaysLinkToLastBuild: false, keepAll: true, reportDir: './', reportFiles: 'PallyReport.html', reportName: 'Pally Report', reportTitles: ''])
														 echo "Starting Zap Test Run- CustomerHub"
                                                          sh 'docker run --add-host tetrapak-dev64a.dev.adobecqms.net:104.46.45.30 --detach --name zap -u zap -v "$(pwd)/reports":/zap/reports/:rw \
                                                         -i owasp/zap2docker-stable zap.sh -daemon -host 0.0.0.0  \
                                                          -config api.addrs.addr.name=.* -config api.addrs.addr.regex=true \
                                                          -config api.disablekey=true'  
														  sleep 20
                                                          sh 'docker exec zap zap-cli spider ${test_url_pally_zap}'
                                                          sh 'docker exec zap zap-cli report -f html -o "zap.html"'
														  sh 'docker cp zap:zap/zap.html .'
														  sh 'docker stop zap'
														  sh 'docker rm zap' 
                                                          publishHTML([allowMissing: false, alwaysLinkToLastBuild: false, keepAll: true, reportDir: './', reportFiles: 'zap.html', reportName: 'zap Report', reportTitles: ''])            
														  sh 'cp -r ./zap.html /app/splunk-output/zap/customerhub'
														  }
								}
						}
				}
														
														stage ( 'Sitespeed Execution on all platforms - CustomerHub') {
													       steps {
														     script {
														if (params.Skip_Tool_Execution) {
                                                        echo "Skipping Sitespeed Execution for Desktop"
                                                        }
                                                        else {
                                                        echo "Starting Sitespeed-Desktop Test Run"
                                                         sh 'docker run --add-host tetrapak-dev64a.dev.adobecqms.net:104.46.45.30 --rm -v "$(pwd)":/sitespeed.io sitespeedio/sitespeed.io ${test_url} -b firefox --outputFolder sitespeed_desktop'
                                                         publishHTML([allowMissing: false, alwaysLinkToLastBuild: false, keepAll: true, reportDir: 'sitespeed_desktop', reportFiles: 'index.html', reportName: 'sitespeed Report Desktop', reportTitles: ''])
                                                         sh 'cp -r ./sitespeed_desktop/index.html /app/splunk-output/sitespeeddesktop'
                                                         echo "Starting Sitespeed-Mobile Test Run"
                                                         sh 'docker run --add-host tetrapak-dev64a.dev.adobecqms.net:104.46.45.30 --rm -v "$(pwd)":/sitespeed.io sitespeedio/sitespeed.io --mobile ${test_url} -b firefox --outputFolder sitespeed_mobile'
                                                         publishHTML([allowMissing: false, alwaysLinkToLastBuild: false, keepAll: true, reportDir: 'sitespeed_mobile', reportFiles: 'index.html', reportName: 'sitespeed Report Mobile', reportTitles: ''])
														 sh 'cp -r ./sitespeed_mobile/index.html /app/splunk-output/sitespeedmobile'
                                                          echo "Starting Sitespeed-IPAD Test Run"
                                                          sh 'docker run --add-host tetrapak-dev64a.dev.adobecqms.net:104.46.45.30 --rm -v "$(pwd)":/sitespeed.io sitespeedio/sitespeed.io --browsertime.viewPort 400x400 --browsertime.userAgent "Mozilla/5.0(iPad; U; CPU iPhone OS 3_2 like Mac OS X; en-us) AppleWebKit/531.21.10 (KHTML, like Gecko) Version/4.0.4 Mobile/7B314 Safari/531.21.10" ${test_url} -b firefox --outputFolder sitespeed_ipad'
                                                          publishHTML([allowMissing: false, alwaysLinkToLastBuild: false, keepAll: true, reportDir: 'sitespeed_ipad', reportFiles: 'index.html', reportName: 'sitespeed Report IPad', reportTitles: ''])
                                                          sh 'cp -r ./sitespeed_ipad/index.html /app/splunk-output/sitespeedipad'
														  }
														  }
														  }
														  }
														  }
post {
      success {
      emailext subject: "SUCCESS: Job '${env.JOB_NAME}'",
      body: '''${DEFAULT_CONTENT}''',
to: 'nitin.kumar1@publicissapient.com, rajeev.duggal@publicissapient.com, sachin.singh1@publicissapient.com, tarun.sagar@publicissapient.com, sumrin.kaur@publicissapient.com'
}
      failure {
      emailext subject: "FAILURE: Job '${env.JOB_NAME}'",
      body: '''${DEFAULT_CONTENT}''',
to: 'nitin.kumar1@publicissapient.com, rajeev.duggal@publicissapient.com, sachin.singh1@publicissapient.com, tarun.sagar@publicissapient.com, sumrin.kaur@publicissapient.com'
}
  always {
    build 'Tetra_Dev_Clear_httpd_Cache'
	build 'Tetra-Splunk-All-Tools'
    } 
	} 
}
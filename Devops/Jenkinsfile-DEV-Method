pipeline {   
        agent any
    //     triggers {
    //     cron('5 0 * * *')
    // }
    parameters {
        booleanParam defaultValue: false, description: 'Please check in case you want to build Commons Module', name: 'Build_Commons'
        booleanParam defaultValue: true, description: 'Please check in case you want to build Public Web Module', name: 'Build_Publicweb'
        booleanParam defaultValue: false, description: 'Please check in case you want to build My Tetra Pak Module', name: 'Build_MyTetraPak'
        booleanParam defaultValue: false, description: 'Please uncheck in case you do not want to perform sonar analysis', name: 'Sonar_Analysis'
        booleanParam defaultValue: false, description: 'Please uncheck in case you do not want to execute the pipeline with all Tools', name: 'Tools_Execution'

        booleanParam defaultValue: true, description: 'Please check in case you want to build Public Web Module', name: 'Build_Publicweb_sitespeed' //Temp
        booleanParam defaultValue: false, description: 'Please check in case you want to build My Tetra Pak Module', name: 'Build_MyTetraPak_sitespeed' //Temp
    }

    options {
        buildDiscarder(logRotator(numToKeepStr: '30'))
        disableConcurrentBuilds()
    }

    environment {
        sonar_url = "https://sonarcloud.io"
        login_token = "2354fbb990d5494aad3c578f2c9dd65147d01e02"
        author_url = "https://author-tetrapak-dev64a.adobecqms.net"
        test_url_cuhu = "https://tetrapak-dev64a.adobecqms.net/content/tetrapak/customerhubtools/global/en/dashboard.html https://tetrapak-dev64a.adobecqms.net/content/tetrapak/customerhubtools/global/en/financials.html"
        test_url_pw = "http://tetrapak-dev64a.adobecqms.net/content/tetrapak/public-web/global/en/innovations.html http://tetrapak-dev64a.adobecqms.net/content/tetrapak/public-web/global/en.html http://tetrapak-dev64a.adobecqms.net/content/tetrapak/public-web/global/en/solutions.html"
        test_url_pally_zap_cuhu = "https://tetrapak-dev64a.adobecqms.net/content/tetrapak/customerhubtools/global/en/dashboard.html"
        test_url_pally_zap_pw = "https://tetrapak-dev64a.adobecqms.net/content/tetrapak/public-web/global/en.html"
        karmapath_cuhu = "${env.WORKSPACE}@2/tetrapak-customerhub/ui.dev/src/coverage"
        karmapath_pw = "${env.WORKSPACE}@2/tetrapak-publicweb/ui.dev/src/coverage"
        build_id_number = ""
    }

    stages {

        stage('init-build-Number') {
            steps {
                script {
                    def now = new Date()
                    def formattedDate
                    formattedDate = now.format("yyyyMMddHHmm")
                    build_id_number = formattedDate
                    echo "build_id_number = ${build_id_number}-SNAPSHOT"
                    echo "${karmapath_cuhu}"

		}
            }
        }

        stage('Build and Sonar analysis') {

            agent {
                dockerfile {
                    args "-v ${env.HOME}/.m2:/root/.m2    --tmpfs /.npm -u root:root"
                    label 'linux&&docker'
                }
            }

            steps {
                script {
                    if (params.Build_Commons) {
                        appname = "commons"
                        buildandsonar()
                    }
                    else {
					    dir('tetrapak-commons') {
					        sh "npm install --prefix ui.dev/src"
						}
					}
                }

                script {
                    if (params.Build_MyTetraPak) {
                        appname = "customerhub"
                        buildandsonar()
                    }
                }

                script {
                    if (params.Build_Publicweb) {
                        appname = "publicweb"
                        buildandsonar()
                    }
                }
            }
        }

        stage('Author and Publisher Deployment') {
            agent {
                node {
                label 'cfe-deploy'
            } 
            }
            steps {
                script {
                author_url = "https://author1.dev.tetrapak.adobecqms.net"
                publish_url = "https://publish1.dev.tetrapak.adobecqms.net"                        
                withCredentials([[$class: 'UsernamePasswordMultiBinding', credentialsId: 'aemcreddev', usernameVariable: 'username', passwordVariable: 'password']])
             {
                 devdeployment()
                 echo "$username"
                 echo "$password"
                 
             }
                }
            }

        }

        stage('Karma, Pa11y, Zap Tools Execution') {
            agent {
                node {
                label 'ubuntu-agentd45a90'
            } 
            }            
            steps {
                script {
                if (!params.Tools_Execution) {
                        echo "Skipping Tools Execution"
                }
                else {
                // if (params.DeployCommons) {
                //     karma()
                //     pally()
                //     sleep 20
                //     zap()
                // }

                if (params.Build_MyTetraPak_sitespeed) {
                    appname = "customerhub"
                    karmatest() 
                    publishHTML([allowMissing: false, alwaysLinkToLastBuild: false, keepAll: true, reportDir: 'customerhub', reportFiles: 'index.html', reportName: 'KarmaReport-MyTetraPak', reportTitles: ''])
                    pallytest()
                    publishHTML([allowMissing: false, alwaysLinkToLastBuild: false, keepAll: true, reportDir: 'pally-customerHub', reportFiles: 'PallyReportCuhu.html', reportName: 'PallyReport- MyTetraPak', reportTitles: ''])
                    zaptest()
                	publishHTML([allowMissing: false, alwaysLinkToLastBuild: false, keepAll: true, reportDir: 'zap-customerHub', reportFiles: 'zap.html', reportName: 'ZAPReport-MyTetraPak', reportTitles: ''])            

                }

                if (params.Build_Publicweb_sitespeed) {
                    appname = "publicweb"
                    karmatest()
					publishHTML([allowMissing: false, alwaysLinkToLastBuild: false, keepAll: true, reportDir: 'publicweb', reportFiles: 'index.html', reportName: 'KarmaReport-Publicweb', reportTitles: ''])
                    pallytest()
					publishHTML([allowMissing: false, alwaysLinkToLastBuild: false, keepAll: true, reportDir: 'pally-publicWeb', reportFiles: 'PallyReportPublicWeb.html', reportName: 'PallyReport-PublicWeb', reportTitles: ''])
                    zaptest()
					publishHTML([allowMissing: false, alwaysLinkToLastBuild: false, keepAll: true, reportDir: 'zap-publicWeb', reportFiles: 'zap.html', reportName: 'ZAPReport-PublicWeb', reportTitles: ''])   

                }
                }
                }
        }
    }
        stage('Sitespeed Execution') {
            agent {
                node {
                label 'ubuntu-agentd45a90'
            } 
            }            
            steps {
                script {
            if (!params.Tools_Execution) {
                echo "Skipping Sitespeed Execution for Desktop"                
            }
            else {
                if (params.Build_MyTetraPak_sitespeed) {
                    test_url = "${test_url_cuhu}"
                    sitespeed()
                }
                if (params.Build_Publicweb_sitespeed) {
                    test_url = "${test_url_pw}"
                    sitespeed()                  
                }
            }
            }
        } 
        }
}
}
    def buildandsonar() {
                echo "Build ${appname}"
                dir("tetrapak-${appname}") {
                sh "rm -rf ui.dev/src/node_modules && rm -rf ui.dev/src/package-lock.json"
                sh "npm cache clean --force"                    
                    withCredentials([[$class: 'UsernamePasswordMultiBinding', credentialsId: 'tetrapak-artifactory-publish-creds', usernameVariable: 'artifactuser', passwordVariable: 'artifactpassword']])
                    {                       
                sh "mvn clean -s settings.xml -Dartuser=${artifactuser} -Dartpassword=${artifactpassword} install deploy -Pminify -Dbuildversion=1.0.0-DEV${build_id_number}-SNAPSHOT"
                    if (!params.Sonar_Analysis) {
                        echo "Skipping Sonar execution for customerhub module"
                    } else {
                        sh "mvn sonar:sonar -Dsonar.organization=tetrapak-smartsales   -Dsonar.host.url=${sonar_url} -Dsonar.buildbreaker.skip=true -Dsonar.login=${login_token} -Dsonar.branch=tetrapack-${appname}  -Dsonar.languages=java,js,css -Dbuildversion=${build_id_number}-SNAPSHOT"
                    }
                }
                    }
    }

    def devdeployment() {
                
        if (params.Build_Commons)  {
                packageName = "tetrapak-commons.complete"
                repoName = "tetrapak"
                fileName = "1.0.0-DEV${build_id_number}-SNAPSHOT"
                devartifactdownload()
                parallel (
                    "Author Commons" : {
                authordeploy()
                    },
                    "Publisher Commons" : {
                publishdeploy()
                    }
                )

            }
        if (params.Build_MyTetraPak) {
                packageName = "tetrapak-customerhub.complete"
                repoName = "tetrapak-customerhub"                
                fileName = "1.0.0-DEV${build_id_number}-SNAPSHOT"
                devartifactdownload()
                parallel (  
                    "Author MyTetrapak" : {                                  
                authordeploy()
                    },
                    "Publisher MyTetrapak" : {                                    
                publishdeploy() 
                    }
                )                           
        }
        if (params.Build_Publicweb) {
                packageName = "tetrapak-publicweb.complete"
                repoName = "tetrapak-publicweb"                
                fileName = "1.0.0-DEV${build_id_number}-SNAPSHOT"
                devartifactdownload()
                parallel (    
                    "Author PublicWeb" : {                                    
                authordeploy()
                    },
                    "Publisher PublicWeb" : {                     
                publishdeploy()  
                    }
                )
            }             

        }
    
    def devartifactdownload() {
        withCredentials([[$class: 'UsernamePasswordMultiBinding', credentialsId: 'tetrapak-artifactory-publish-creds', usernameVariable: 'artifactuser', passwordVariable: 'artifactpassword']])
        {
                sh "curl -LO -k -k -u ${artifactuser}:${artifactpassword} https://tetrapak.jfrog.io/tetrapak/libs-snapshot-local/${repoName}/${packageName}/${fileName}/${packageName}-${fileName}.zip"
                echo "https://tetrapak.jfrog.io/tetrapak/libs-snapshot-local/${repoName}/${packageName}/${fileName}/${packageName}-${fileName}.zip"

        }

    }

    def authordeploy() {
                
                echo "Uninstalling Old Commons Package on author for Commons"
                sh "curl -k -u ${username}:${password} -F force=true '${author_url}/crx/packmgr/service.jsp?cmd=uninst&name=${packageName}'"
                sleep 10
                echo "Deleting Old Commons Package on author"
                sh "curl -k -u ${username}:${password} -F force=true '${author_url}/crx/packmgr/service.jsp?cmd=rm&name=${packageName}'"
                sleep 10
                echo "Uploading New Commons Package on author"
                sh "curl -k -u ${username}:${password} -F name=${packageName} -F file=@${packageName}-${fileName}.zip -F force=true '${author_url}/crx/packmgr/service.jsp?cmd=upload' --verbose"
                sleep 20
                echo "Installing New Commons Package on author"
                sh "curl -k -u ${username}:${password} -F force=true '${author_url}/crx/packmgr/service.jsp?cmd=inst&name=${packageName}'"
                sleep 20

    }

    def publishdeploy() {
                
                echo "Uninstalling Old Commons Package on publish for Commons"
                sh "curl -k -u ${username}:${password} -F force=true '${publish_url}/crx/packmgr/service.jsp?cmd=uninst&name=${packageName}'"
                sleep 10
                echo "Deleting Old Commons Package on publish"
                sh "curl -k -u ${username}:${password} -F force=true '${publish_url}/crx/packmgr/service.jsp?cmd=rm&name=${packageName}'"
                sleep 10
                echo "Uploading New Commons Package on publish"
                sh "curl -k -u ${username}:${password} -F name=${packageName} -F file=@${packageName}-${fileName}.zip -F force=true '${publish_url}/crx/packmgr/service.jsp?cmd=upload' --verbose"
                sleep 20
                echo "Installing New Commons Package on publish"
                sh "curl -k -u ${username}:${password} -F force=true '${publish_url}/crx/packmgr/service.jsp?cmd=inst&name=${packageName}'"
                sleep 20

    }

    def karmatest() {
                echo "Publising karma Test Report- ${appname}"
                sh 'echo "Karma Report"'
                reportname = "Karma Report - ${appname}"
                sh "cp -r ${karmapath_cuhu} ${appname}"
    }

    def pallytest() {
                if (params.Build_MyTetraPak) {
                    echo "Starting pa11y test Run on CustomerHub Urls"
                    reportname = "Pa11y Report - CustomerHub"
                    sh "mkdir -p pally-customerHub"
                    pallycuhuscript()
                    sh 'mv PallyReportCuhu.html pally-customerHub/PallyReportCuhu.html' 
                }
                if (params.Build_Publicweb) {
                    echo "Starting pa11y test Run on PublicWeb Urls"
                    reportname = "Pa11y Report - publicweb"
                    sh "mkdir -p pally-publicWeb"
                    pallypwscript()
                    sh 'mv PallyReportPublicWeb.html pally-publicWeb/PallyReportPublicWeb.html'
                }
        }

    def zaptest() {
                echo "Starting Zap Test Run- ${appname}"
                sh 'docker ps -a'
                sh 'docker stop zap'
                sh 'docker run --add-host tetrapak-dev64a.dev.adobecqms.net:104.46.45.30 -e LANG=C.UTF-8 --detach --name zap -u zap -v "$(pwd)/reports":/zap/reports/:rw owasp/zap2docker-stable zap.sh -daemon -host 0.0.0.0  -config api.addrs.addr.name=.* -config api.addrs.addr.regex=true -config api.disablekey=true'  
                sleep 20
                echo "Starting ZAP test Run on ${appname} Urls"
                sh 'docker exec  zap zap-cli spider ${test_url_pally_zap_cuhu}'
                sh 'docker exec  zap zap-cli report -f html -o zap.html'
                sh "mkdir -p zap-${appname}"
                sh "docker cp zap:zap/zap.html zap-${appname}"
                sh 'docker stop zap'
                sh 'docker rm zap'  
        }

    def pallycuhuscript() {
                sh '''
                    #!/bin/bash
                    cat Devops/PallyUrlsCuhu.txt | while read LINE; do 
                    if [[ -z $LINE ]]
                    then
                    exit
                    fi
                    echo "url to test : $LINE"
                    docker run --add-host tetrapak-dev64a.dev.adobecqms.net:104.46.45.30 dcycle/pa11y --rm -r html -s WCAG2AA -i "notice;warning" -i "WCAG2AA.Principle1.Guideline1_1.1_1_1.H67.2;WCAG2AA.Principle1.Guideline1_1.1_1_1.G94.Image;WCAG2AA.Principle1.Guideline1_1.1_1_1.H24;WCAG2AA.Principle1.Guideline1_1.1_1_1.H24.2;WCAG2AA.Principle1.Guideline1_1.1_1_1.G73,G74;WCAG2AA.Principle1.Guideline1_1.1_1_1.H2.EG5;WCAG2AA.Principle1.Guideline1_1.1_1_1.H2.EG3;WCAG2AA.Principle1.Guideline1_1.1_1_1.G94,G92.Object;WCAG2AA.Principle1.Guideline1_2.1_2_4.G9,G87,G93;WCAG2AA.Principle1.Guideline1_2.1_2_2.G87,G93;WCAG2AA.Principle1.Guideline1_2.1_2_5.G78,G173,G8;WCAG2AA.Principle1.Guideline1_3.1_3_1.H48.1;WCAG2AA.Principle1.Guideline1_3.1_3_1.H48.2;WCAG2AA.Principle1.Guideline1_3.1_3_2.G57;WCAG2AA.Principle1.Guideline1_4.1_4_2.F23;WCAG2AA.Principle1.Guideline1_4.1_4_1.G14,G182;WCAG2AA.Principle1.Guideline1_4.1_4_3.G18.Fail;WCAG2AA.Principle1.Guideline1_4.1_4_3.G145.Fail;WCAG2AA.Principle1.Guideline1_4.1_4_3.G18;WCAG2AA.Principle1.Guideline1_4.1_4_3.G145;WCAG2AA.Principle1.Guideline1_4.1_4_3.F24.BGColour;WCAG2AA.Principle1.Guideline1_4.1_4_3.F24.FGColour;WCAG2AA.Principle1.Guideline1_4.1_4_4.G142;WCAG2AA.Principle1.Guideline1_4.1_4_5.G140,C22,C30.AALevel;WCAG2AA.Principle3.Guideline3_2.3_2_2.H32.2;WCAG2AA.Principle3.Guideline3_2.3_2_3.G61;WCAG2AA.Principle3.Guideline3_2.3_2_4.G197;WCAG2AA.Principle3.Guideline3_3.3_3_1.G83,G84,G85;WCAG2AA.Principle4.Guideline4_1.4_1_2.H91.InputRange.Name;WCAG2AA.Principle4.Guideline4_1.4_1_2.H91.A.NoContent" "$LINE"
                    done > PallyReportCuhu.html
                    set +e
               '''
    }
    
    def pallypwscript() {
                sh '''
                    #!/bin/bash
                    cat Devops/PallyUrlsPublicWeb.txt | while read LINE; do 
                    if [[ -z $LINE ]]
                    then
                    exit
                    fi
                    echo "url to test : $LINE"
                    docker run dcycle/pa11y --rm -r html -s WCAG2AA -i "notice;warning" -i "WCAG2AA.Principle1.Guideline1_1.1_1_1.H67.2;WCAG2AA.Principle1.Guideline1_1.1_1_1.G94.Image;WCAG2AA.Principle1.Guideline1_1.1_1_1.H24;WCAG2AA.Principle1.Guideline1_1.1_1_1.H24.2;WCAG2AA.Principle1.Guideline1_1.1_1_1.G73,G74;WCAG2AA.Principle1.Guideline1_1.1_1_1.H2.EG5;WCAG2AA.Principle1.Guideline1_1.1_1_1.H2.EG3;WCAG2AA.Principle1.Guideline1_1.1_1_1.G94,G92.Object;WCAG2AA.Principle1.Guideline1_2.1_2_4.G9,G87,G93;WCAG2AA.Principle1.Guideline1_2.1_2_2.G87,G93;WCAG2AA.Principle1.Guideline1_2.1_2_5.G78,G173,G8;WCAG2AA.Principle1.Guideline1_3.1_3_1.H48.1;WCAG2AA.Principle1.Guideline1_3.1_3_1.H48.2;WCAG2AA.Principle1.Guideline1_3.1_3_2.G57;WCAG2AA.Principle1.Guideline1_4.1_4_2.F23;WCAG2AA.Principle1.Guideline1_4.1_4_1.G14,G182;WCAG2AA.Principle1.Guideline1_4.1_4_3.G18.Fail;WCAG2AA.Principle1.Guideline1_4.1_4_3.G145.Fail;WCAG2AA.Principle1.Guideline1_4.1_4_3.G18;WCAG2AA.Principle1.Guideline1_4.1_4_3.G145;WCAG2AA.Principle1.Guideline1_4.1_4_3.F24.BGColour;WCAG2AA.Principle1.Guideline1_4.1_4_3.F24.FGColour;WCAG2AA.Principle1.Guideline1_4.1_4_4.G142;WCAG2AA.Principle1.Guideline1_4.1_4_5.G140,C22,C30.AALevel;WCAG2AA.Principle3.Guideline3_2.3_2_2.H32.2;WCAG2AA.Principle3.Guideline3_2.3_2_3.G61;WCAG2AA.Principle3.Guideline3_2.3_2_4.G197;WCAG2AA.Principle3.Guideline3_3.3_3_1.G83,G84,G85;WCAG2AA.Principle4.Guideline4_1.4_1_2.H91.InputRange.Name;WCAG2AA.Principle4.Guideline4_1.4_1_2.H91.A.NoContent" "$LINE"
                    done > PallyReportPublicWeb.html
                    set +e
                '''
    }


    def sitespeed() {
                echo "Starting Sitespeed-Desktop Test Run for CustomerHub"
                sh 'docker run --add-host tetrapak-dev64a.dev.adobecqms.net:104.46.45.30 --rm -v "$(pwd)":/sitespeed.io sitespeedio/sitespeed.io ${test_url} -b firefox --outputFolder sitespeed_desktop'
                publishHTML([allowMissing: false, alwaysLinkToLastBuild: false, keepAll: true, reportDir: 'sitespeed_desktop', reportFiles: 'index.html', reportName: 'SitespeedReport-MyTetraPak-Desktop', reportTitles: ''])

                echo "Starting Sitespeed-Mobile Test Run for CustomerHub"
                sh 'docker run --add-host tetrapak-dev64a.dev.adobecqms.net:104.46.45.30 --rm -v "$(pwd)":/sitespeed.io sitespeedio/sitespeed.io --mobile ${test_url} -b firefox --outputFolder sitespeed_mobile'
                publishHTML([allowMissing: false, alwaysLinkToLastBuild: false, keepAll: true, reportDir: 'sitespeed_mobile', reportFiles: 'index.html', reportName: 'SitespeedReport-MyTetraPak-Mobile', reportTitles: ''])

                echo "Starting Sitespeed-IPAD Test Run for CustomerHub"
                sh 'docker run --add-host tetrapak-dev64a.dev.adobecqms.net:104.46.45.30 --rm -v "$(pwd)":/sitespeed.io sitespeedio/sitespeed.io --browsertime.viewPort 400x400 --browsertime.userAgent "Mozilla/5.0(iPad; U; CPU iPhone OS 3_2 like Mac OS X; en-us) AppleWebKit/531.21.10 (KHTML, like Gecko) Version/4.0.4 Mobile/7B314 Safari/531.21.10" ${test_url} -b firefox --outputFolder sitespeed_ipad'
                publishHTML([allowMissing: false, alwaysLinkToLastBuild: false, keepAll: true, reportDir: 'sitespeed_ipad', reportFiles: 'index.html', reportName: 'SitespeedReport-MyTetraPak-IPad', reportTitles: ''])
                        }                

    // def pallycuhu() {
    //             echo "Starting pa11y test Run on CustomerHub Urls"
    //             reportname = "Pa11y Report - CustomerHub"
    //             sh 'chmod 777 Devops/PallyReportCuhu.sh'
    //             sh 'sh -x Devops/PallyReportCuhu.sh'
    //             sh 'mkdir -p pally-customerHub'
    //             sh 'mv PallyReportCuhu.html pally-customerHub/PallyReportCuhu.html' 
    //             publishHTML([allowMissing: false, alwaysLinkToLastBuild: false, keepAll: true, reportDir: 'pally-customerHub', reportFiles: 'PallyReportCuhu.html', reportName: 'PallyReport- MyTetraPak', reportTitles: ''])
    // }

    // def pallypw() {
    //             echo "Starting pa11y test Run on PublicWeb Urls"
    //             reportname = "Pa11y Report - publicweb"
	// 			sh 'chmod 777 Devops/PallyReportPubWeb.sh'
	// 			sh 'sh -x Devops/PallyReportPubWeb.sh'
	// 			sh 'mkdir -p pally-publicWeb'
    //             sh 'mv PallyReportPublicWeb.html pally-publicWeb/PallyReportPublicWeb.html' 
	// 			publishHTML([allowMissing: false, alwaysLinkToLastBuild: false, keepAll: true, reportDir: 'pally-publicWeb', reportFiles: 'PallyReportPublicWeb.html', reportName: 'PallyReport-PublicWeb', reportTitles: ''])
                 			                
    // }
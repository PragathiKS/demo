@Library('jenkins-pipeline-library') _

pipeline {
    agent {
        node {
        label 'cfe-deploy'
       }
    }
         triggers {
         cron('H 20 * * 1-5')
     }

    parameters {
        booleanParam defaultValue: true, description: 'Please check in case you want to run E2E Test Module', name: 'E2E_Test'

    }

    options {
        buildDiscarder(logRotator(numToKeepStr: '30'))
        disableConcurrentBuilds()
    }

    environment {
        sonar_url = "https://sonarcloud.io"
        login_token = "2354fbb990d5494aad3c578f2c9dd65147d01e02"
        build_id_number = ""
    }

    stages {

        stage('init-build-Number') {
            steps {
                script {
                    def now = new Date()
                    def formattedDate
                    formattedDate = now.format("yyyyMMddHHmm")
                    build_id_number = formattedDate
                    echo "build_id_number = ${build_id_number}-SNAPSHOT"

                }
            }
        }

        stage('Build and Sonar analysis') {

            agent {
                dockerfile {
                    args "-v ${env.HOME}/.m2:/root/.m2    --tmpfs /.npm -u root:root"
                    label 'cfe-deploy'
                }
            }

            steps {

                 script {
                    if (params.E2E_Test) {
                        appname = "supplierportal"
                        buildandsonar()
                    }
                }

            }
        }





}
}




def buildandsonar() {
                echo "Build ${appname}"
                dir("tetrapak-${appname}/e2e.tests") {

                    withCredentials([[$class: 'UsernamePasswordMultiBinding', credentialsId: 'tetrapak-artifactory-publish-creds', usernameVariable: 'artifactuser', passwordVariable: 'artifactpassword']])
                    {
                     sh "mvn clean install sonar:sonar -Dsonar.organization=tetrapak-smartsales   -Dsonar.host.url=${sonar_url} -Dsonar.buildbreaker.skip=true -Dsonar.login=${login_token} -Dsonar.branch=tetrapack-${appname}/e2e.tests  -Dsonar.languages=java,js,css  -Dsonar.test.exclusions=**/core/src/test/**  -DskipTests"
                    }
    }
}



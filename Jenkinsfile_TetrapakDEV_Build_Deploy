pipeline {
    agent any	
	parameters {
    choice choices: ['tetrapak-customerhub', 'tetrapak-publicweb'], description: '', name: 'CHOICE'
	booleanParam defaultValue: false, description: 'Please check in case you do not want to run the pipeline with all Tools execution', name: 'Skip_Test'
                }
    tools {
        maven 'maven'
        jdk 'jdk8'
    }
	
	environment {
     sonar_url = "http://127.0.0.1:9000"
	 author_url = "http://13.69.79.81:4502"
	 publish_url = "http://13.69.73.197:4503"
	 package_name = "tetrapak-complete-package"
	 test_url = "http://tetrapak-dev64a.adobecqms.net/content/tetrapak/customerhub/global/dashboard.html http://tetrapak-dev64a.adobecqms.net/content/tetrapak/customerhub/global/installed-equipment.html http://tetrapak-dev64a.adobecqms.net/content/tetrapak/customerhub/global/ordering/order-history.html  http://tetrapak-dev64a.adobecqms.net/content/tetrapak/customerhub/global/financials.html  http://tetrapak-dev64a.adobecqms.net/content/tetrapak/customerhub/global/training.html  http://tetrapak-dev64a.adobecqms.net/content/tetrapak/customerhub/global/projects.html  http://tetrapak-dev64a.adobecqms.net/content/tetrapak/customerhub/global/contact.html  http://tetrapak-dev64a.adobecqms.net/content/tetrapak/customerhub/global/about-us.html"
	 test_url_pally_zap = "http://tetrapak-dev64a.adobecqms.net"
   }
   
    stages {
        stage ('Initialize') {
            steps {
                sh '''
                    echo "PATH = ${PATH}"
                    echo "M2_HOME = ${M2_HOME}"
                '''
            }
        }

        stage ('Build') {
            steps {
			    sh "npm install --prefix $workspace/tetrapak-commons/ui.dev/src"
			    sh "npm install --prefix $workspace/${params.CHOICE}/ui.dev/src"
				sh "mvn -f $workspace/tetrapak-commons/pom.xml clean org.jacoco:jacoco-maven-plugin:prepare-agent install -Pminify -Dbuildversion=1.0.0-DEV${BUILD_NUMBER}"
                sh "mvn -f $workspace/${params.CHOICE}/pom.xml clean org.jacoco:jacoco-maven-plugin:prepare-agent install -Pminify -Dbuildversion=1.0.0-DEV${BUILD_NUMBER}"
				sh "cp $workspace/tetrapak-commons/complete/target/tetrapak-commons.complete-1.0.0-DEV${BUILD_NUMBER}.zip /app/build-area/releases/DEVBUILD"
				sh "cp $workspace/${params.CHOICE}/complete/target/${params.CHOICE}.complete-1.0.0-DEV${BUILD_NUMBER}.zip /app/build-area/releases/DEVBUILD"
				 
            }  
        }
		

		stage ('Deployment Author and Publish Parallel') {
		    steps {
			  script {
			   parallel (
			       "Author Deployment" : {
				        if (params.Skip_Test) {
			             echo "Stage is Skipped"
					                           }
					  else
					   {
					   echo "Stage is Processed"
					    }
					    
			                                  },
		                    

		            "Publish_Deployment" : {
		                echo "Uninstalling Old Package"
						
			                                     }
		                )  
						}
			                  }
			                                               }
		stage ('Dispatcher Flush, Pa11y, Sitespeed, Zap Tools Execution') {
		    steps {

            echo "Cache Flush Started"
			sh "curl -X POST --header 'CQ-Action: Delete' --header CQ-Handle:/home --header CQ-Page:/home 'http://10.202.13.229/dispatcher/invalidate.cache'"
			sh "curl -X POST --header 'CQ-Action: Delete' --header CQ-Handle:/content --header CQ-Page:/content 'http://10.202.13.229/dispatcher/invalidate.cache'"
			sh "curl -X POST --header 'CQ-Action: Delete' --header CQ-Handle:/etc --header CQ-Page:/etc 'http://10.202.13.229/dispatcher/invalidate.cache'"
			sh "curl -X POST --header 'CQ-Action: Delete' --header CQ-Handle:/libs --header CQ-Page:/libs 'http://10.202.13.229/dispatcher/invalidate.cache'"

		     	
				
                			
            }						
		}
	}
	}
		